<% const headerData = { brandText: locals.brandText || 'ë§ˆë²•ì—°êµ¬íšŒ', brandHref:
locals.brandHref || '/', userName: locals.userName || 'User', userRole:
locals.userRole || 'ì‚¬ìš©ì', notificationCount: locals.notificationCount || 0,
...locals }; %>

<link rel="stylesheet" href="/partials/header.css" />

<header class="main-header">
    <div class="header-container">
        <div class="header-brand">
            <a href="<%= headerData.brandHref %>" class="brand-link">
                <span class="brand-icon">ğŸ”®</span>
                <span class="brand-text"><%= headerData.brandText %></span>
            </a>
        </div>

        <nav class="header-nav">
            <!-- Desktop Navigation -->
            <ul class="nav-list desktop-nav">
                <li class="nav-item">
                    <a href="/novel" class="nav-link">
                        <span class="material-symbols-outlined"
                            >library_books</span
                        >
                        <span>ì•„ì¹´ì´ë¸Œ</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/community" class="nav-link">
                        <span class="material-symbols-outlined">groups</span>
                        <span>ì»¤ë®¤ë‹ˆí‹°</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/emojis" class="nav-link">
                        <span class="material-symbols-outlined">Glyphs</span>
                        <span>ë§ˆì—°íšŒì½˜</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a href="/research" class="nav-link">
                        <span class="material-symbols-outlined">science</span>
                        <span>ë§ˆë²•ì—°êµ¬ì†Œ</span>
                    </a>
                </li>

            </ul>

            <!-- Mobile Navigation -->
            <div class="mobile-nav dropdown">
                <button class="nav-toggle dropdown-toggle" id="mobileNavToggle">
                    <span class="material-symbols-outlined">apps</span>
                    <span>ì„œë¹„ìŠ¤</span>
                    <span class="material-symbols-outlined dropdown-arrow"
                        >expand_more</span
                    >
                </button>
                <ul class="dropdown-menu mobile-nav-menu" id="mobileNavMenu">
                    <li>
                        <a href="/novel" class="dropdown-link">
                            <span class="material-symbols-outlined"
                                >library_books</span
                            >
                            <span>ì•„ì¹´ì´ë¸Œ</span>
                        </a>
                    </li>
                    <li>
                        <a href="/community" class="dropdown-link">
                            <span class="material-symbols-outlined"
                                >groups</span
                            >
                            <span>ì»¤ë®¤ë‹ˆí‹°</span>
                        </a>
                    </li>
                    <li>
                        <a href="/emojis" class="dropdown-link">
                            <span class="material-symbols-outlined"
                                >Glyphs</span
                            >
                            <span>ë§ˆì—°íšŒì½˜</span>
                        </a>
                    </li>
                    <li>
                        <a href="/research" class="dropdown-link">
                            <span class="material-symbols-outlined"
                                >science</span
                            >
                            <span>ë§ˆë²•ì—°êµ¬ì†Œ</span>
                        </a>
                    </li>

                </ul>
            </div>
        </nav>

        <div class="header-actions">
            <button class="action-btn notification-btn" id="notificationBtn">
                <span class="material-symbols-outlined">notifications</span>
                <% if (headerData.notificationCount > 0) { %>
                <span class="notification-badge"
                    ><%= headerData.notificationCount %></span
                >
                <% } %>
            </button>

            <div class="user-menu dropdown">
                <button
                    class="user-menu-toggle dropdown-toggle"
                    id="userMenuToggle"
                >
                    <div class="user-avatar">
                        <span class="material-symbols-outlined">person</span>
                    </div>
                    <div class="header-user-info">
                        <span class="user-name"
                            ><%= headerData.userName %></span
                        >
                        <span class="user-role"
                            ><%= headerData.userRole %></span
                        >
                    </div>
                    <span class="material-symbols-outlined dropdown-arrow"
                        >expand_more</span
                    >
                </button>
                <ul class="dropdown-menu user-dropdown" id="userMenu">
                    <li>
                        <a href="/mypage" class="dropdown-link">
                            <span class="material-symbols-outlined"
                                >person</span
                            >
                            <span>ë§ˆì´í˜ì´ì§€</span>
                        </a>
                    </li>
                                        <li>
                        <a href="/settings" class="dropdown-link">
                            <span class="material-symbols-outlined"
                                >settings</span
                            >
                            <span>ì„¤ì •</span>
                        </a>
                    </li>
                    <li id="admin-menu-item" style="display: none;">
                        <a href="/admin" class="dropdown-link admin-dropdown-link">
                            <span class="material-symbols-outlined"
                                >admin_panel_settings</span
                            >
                            <span>ê´€ë¦¬ì ë©”ë‰´</span>
                        </a>
                    </li>
                    <li>
                        <button
                            class="dropdown-link mobile-theme-toggle"
                            id="mobileThemeToggle"
                        >
                            <span class="material-symbols-outlined"
                                >dark_mode</span
                            >
                            <span>ë‹¤í¬ëª¨ë“œ</span>
                        </button>
                    </li>
                    <li class="dropdown-divider"></li>
                    <li>
                        <button
                            class="dropdown-link logout-link"
                            id="logoutBtn"
                        >
                            <span class="material-symbols-outlined"
                                >logout</span
                            >
                            <span>ë¡œê·¸ì•„ì›ƒ</span>
                        </button>
                    </li>
                </ul>
            </div>

            <button class="action-btn theme-toggle" id="themeToggle">
                <span class="material-symbols-outlined">dark_mode</span>
            </button>
        </div>
    </div>
</header>


<style>
    .admin-dropdown-link,
    .admin-dropdown-link .material-symbols-outlined {
        color: #f59e0b;
        font-weight: 500;
    }

    .admin-dropdown-link:hover,
    .admin-dropdown-link:hover .material-symbols-outlined {
        color: #d97706;
    }

    [data-theme="dark"] .admin-dropdown-link,
    [data-theme="dark"] .admin-dropdown-link .material-symbols-outlined {
        color: #fbbf24;
    }

    [data-theme="dark"] .admin-dropdown-link:hover,
    [data-theme="dark"] .admin-dropdown-link:hover .material-symbols-outlined {
        color: #f59e0b;
    }
</style>
 
<script>
    document.body.classList.add('has-header');

    if (!window.headerEventsSetup) {
        window.headerEventsSetup = true;

        function setupDropdowns() {
            const dropdowns = document.querySelectorAll('.dropdown');

            dropdowns.forEach((dropdown) => {
                const toggle = dropdown.querySelector('.dropdown-toggle');
                const menu = dropdown.querySelector('.dropdown-menu');

                if (toggle && menu) {
                    toggle.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();

                        // Close other dropdowns
                        dropdowns.forEach((otherDropdown) => {
                            if (otherDropdown !== dropdown) {
                                otherDropdown.classList.remove('open');
                            }
                        });

                        dropdown.classList.toggle('open');
                    });
                }
            });

            document.addEventListener('click', () => {
                dropdowns.forEach((dropdown) => {
                    dropdown.classList.remove('open');
                });
            });
        }

        function setupThemeToggle() {
            const themeToggle = document.getElementById('themeToggle');
            const mobileThemeToggle =
                document.getElementById('mobileThemeToggle');

            const desktopIcon = themeToggle?.querySelector(
                '.material-symbols-outlined'
            );
            const mobileIcon = mobileThemeToggle?.querySelector(
                '.material-symbols-outlined'
            );

            function updateThemeIcon(theme) {
                const iconText = theme === 'dark' ? 'light_mode' : 'dark_mode';
                if (desktopIcon) desktopIcon.textContent = iconText;
                if (mobileIcon) mobileIcon.textContent = iconText;
            }

            function toggleTheme() {
                const currentTheme =
                    document.documentElement.getAttribute('data-theme') ||
                    'light';
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.documentElement.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeIcon(newTheme);
            }

            if (themeToggle) {
                themeToggle.addEventListener('click', toggleTheme);
            }

            if (mobileThemeToggle) {
                mobileThemeToggle.addEventListener('click', toggleTheme);
            }

            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            updateThemeIcon(savedTheme);
        }

        function setupLogout() {
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', async () => {
                    try {
                        const { default: apiClient } = await import(
                            '/module/api.js'
                        );
                        const response = await apiClient.post('/api/v1/auth/logout');
                        
                        if (response && response.success) {
                            window.location.href = '/login';
                        } else {
                            localStorage.removeItem('accessToken');
                            document.cookie = 'refreshToken=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                            window.location.href = '/login';
                        }
                    } catch (error) {
                        console.error('Logout failed', error);
                        localStorage.removeItem('accessToken');
                        document.cookie = 'refreshToken=; path=/; expires=Thu, 01 Jan 1970 00:00:01 GMT;';
                        window.location.href = '/login';
                    }
                });
            }
        }

        async function fetchAndUpdateUserData() {
            if (window.headerUserDataSetup) return;
            window.headerUserDataSetup = true;

            const authPages = ['/login', '/register', '/find-password'];
            if (authPages.includes(window.location.pathname)) {
                updateUIForGuest();
                return;
            }

            const publicPages = ['/help', '/contact', '/feedback', '/notice', '/license'];
            const userProfilePattern = /^\/user\/[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}(\/activity|\/guestbook)?$/;
            const isPublicPage = publicPages.includes(window.location.pathname) || userProfilePattern.test(window.location.pathname);

            try {
                const { default: apiClient } = await import('/module/api.js');
                const data = await apiClient.get('/api/v1/auth/me');
                
                if (!data || !data.user) {
                    throw new Error('ì‚¬ìš©ì ì •ë³´ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }
                
                const user = data.user;

                document
                    .querySelectorAll('.user-name')
                    .forEach((el) => (el.textContent = user.nickname));
                const userRole =
                    user.authority === 'admin' ? 'ê´€ë¦¬ì' : 'ì‚¬ìš©ì';
                document
                    .querySelectorAll('.user-role')
                    .forEach((el) => (el.textContent = userRole));

                const notificationBadge = document.querySelector(
                    '.notification-badge'
                );
                if (notificationBadge) {
                    const count = user.notificationCount || 0;
                    notificationBadge.textContent = count;
                    notificationBadge.style.display =
                        count > 0 ? 'inline' : 'none';
                }

                const adminMenuItem = document.getElementById('admin-menu-item');
                if (adminMenuItem) {
                    adminMenuItem.style.display =
                        user.authority === 'admin' ? 'block' : 'none';
                }

                const avatarDiv = document.querySelector('.user-avatar');
                if (avatarDiv && user.profileImage) {
                    avatarDiv.innerHTML = `<img src="${user.profileImage}" alt="${user.nickname}ë‹˜ì˜ í”„ë¡œí•„ ì‚¬ì§„" class="profile-picture">`;
                }

                document.dispatchEvent(
                    new CustomEvent('userLoaded', { detail: { user } })
                );
            } catch (error) {
                console.error('Header user data update failed:', error);
                if (isPublicPage) {
                    console.log('ê³µê°œ í˜ì´ì§€ì—ì„œ ì¸ì¦ ì‹¤íŒ¨, ê²ŒìŠ¤íŠ¸ UI í‘œì‹œ');
                }
                updateUIForGuest();
            }
        }

        function updateUIForGuest() {
            document
                .querySelectorAll('.user-name')
                .forEach((el) => (el.textContent = 'ê²ŒìŠ¤íŠ¸'));
            document
                .querySelectorAll('.user-role')
                .forEach((el) => (el.textContent = 'ë¡œê·¸ì¸ í•„ìš”'));

            const avatarDiv = document.querySelector('.user-avatar');
            if (avatarDiv) {
                avatarDiv.innerHTML = `<span class="material-symbols-outlined">person</span>`;
            }

            const userMenu = document.getElementById('userMenu');
            if (userMenu) {
                userMenu.innerHTML = `
                    <li>
                        <a href="/login" class="dropdown-link">
                            <span class="material-symbols-outlined">login</span>
                            <span>ë¡œê·¸ì¸</span>
                        </a>
                    </li>
                `;
            }
        }

        function setupNotifications() {
            const notificationBtn = document.getElementById('notificationBtn');
            if (notificationBtn) {
                notificationBtn.addEventListener('click', () => {
                    console.log('ì•Œë¦¼ ë²„íŠ¼ í´ë¦­ë¨');
                });
            }
        }

        function setupHeaderScroll() {
            let lastScrollY = window.scrollY;
            let ticking = false;
            const header = document.querySelector('.main-header');
            if (!header) return;

            function updateHeader() {
                const scrollY = window.scrollY;
                const scrollDirection = scrollY > lastScrollY ? 'down' : 'up';
                const scrollDelta = Math.abs(scrollY - lastScrollY);

                if (scrollY === 0) {
                    header.classList.remove('header-hidden');
                } else if (
                    scrollY > 50 &&
                    scrollDirection === 'up' &&
                    scrollDelta > 2
                ) {
                    header.classList.add('header-hidden');
                } else if (scrollDirection === 'down' && scrollDelta > 1) {
                    header.classList.remove('header-hidden');
                }

                if (scrollY > 50) {
                    header.classList.add('header-shadow');
                } else {
                    header.classList.remove('header-shadow');
                }

                lastScrollY = scrollY;
                ticking = false;
            }

            function requestTick() {
                if (!ticking) {
                    requestAnimationFrame(updateHeader);
                    ticking = true;
                }
            }

            window.addEventListener('scroll', requestTick, { passive: true });

            let touchStartY = 0;
            let touchEndY = 0;

            window.addEventListener(
                'touchstart',
                (e) => {
                    touchStartY = e.changedTouches[0].screenY;
                },
                { passive: true }
            );

            window.addEventListener(
                'touchend',
                (e) => {
                    touchEndY = e.changedTouches[0].screenY;
                    const touchDelta = touchStartY - touchEndY;

                    if (Math.abs(touchDelta) > 50) {
                        if (touchDelta < 0) {
                            header.classList.add('header-hidden');
                        } else {
                            header.classList.remove('header-hidden');
                        }
                    }
                },
                { passive: true }
            );
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => {
                setupDropdowns();
                setupThemeToggle();
                setupLogout();
                fetchAndUpdateUserData();
                setupNotifications();
                setupHeaderScroll();
            });
        } else {
            setupDropdowns();
            setupThemeToggle();
            setupLogout();
            fetchAndUpdateUserData();
            setupNotifications();
            setupHeaderScroll();
        }
    }
</script>
